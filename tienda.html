<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda en L√≠nea - Cliente</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#014421"> 
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* COLORES SOLICITADOS */
        :root {
            --color-barra: #014421; 
            --color-fondo: #F5F5F5; 
            --color-botones: #C0C0C0; 
            --color-texto-barra: #ffffff; 
            --color-texto-oscuro: #333333; 
            --color-acento-claro: #E0E0E0; 
        }
        
        body {
            background-color: var(--color-fondo);
            font-family: 'Poppins', sans-serif; 
            padding-top: 0; 
            color: var(--color-texto-oscuro);
        }

        .content-padding {
            padding-top: 90px; 
        }

        /* === NAVBAR === */
        .navbar-custom {
            background-color: var(--color-barra) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; 
            border: none !important; 
            padding: 0.5rem 0; 
            transition: padding 0.3s ease;
            z-index: 1050; 
        }
        
        .navbar-custom .navbar-brand {
            font-size: 1.6rem; 
            font-weight: 800; 
            letter-spacing: 0.5px;
            color: var(--color-texto-barra) !important;
            font-family: 'Poppins', sans-serif; 
            line-height: 1;
            margin-right: 0;
            text-decoration: none; 
            display: flex;
            align-items: center;
        }
        
        .navbar-logo {
            height: 45px; 
            width: 45px;  
            margin-right: 10px; 
            border-radius: 50%; 
            object-fit: contain; 
            background-color: transparent; 
        }

        .navbar-toggler {
            border: none;
            padding: 0.25rem;
        }
        .navbar-toggler:focus {
            box-shadow: none;
        }
        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        /* === BOTONES NAV === */
        .btn-nav-elegant {
            background-color: var(--color-botones) !important;
            color: var(--color-texto-oscuro) !important; 
            border: none !important; 
            border-radius: 50px; 
            padding: 0.5rem 1.2rem; 
            min-width: 120px;      
            width: auto;
            font-size: 0.95rem; 
            font-weight: 600; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); 
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px; 
        }
        
        .btn-nav-elegant i { font-size: 1.2rem; }

        .btn-nav-elegant:hover, .btn-nav-elegant:focus {
            background-color: var(--color-barra) !important; 
            color: #ffffff !important; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transform: translateY(-1px);
        }

        /* BOTONES PRODUCTO */
        .btn-custom { 
            background-color: var(--color-botones) !important;
            border-color: var(--color-botones) !important;
            color: var(--color-texto-oscuro) !important;
            border-radius: 25px; 
            transition: all 0.3s ease;
            font-weight: 600;
            padding: 0.5rem 1.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
            border: none !important; 
        }
        .btn-custom:hover {
            background-color: var(--color-barra) !important; 
            border-color: var(--color-barra) !important;
            color: var(--color-texto-barra) !important;
            transform: scale(1.02);
        }
        .card .btn-custom { margin-top: 10px; font-size: 1rem; }

        /* === ESTILOS CARRITO === */
        #lista-carrito-container {
            padding-top: 50px;
            padding-bottom: 20px;
        }

        .cart-item-box {
            background-color: white;
            border: 1px solid var(--color-acento-claro);
            border-radius: 12px;
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.08); 
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cart-item-img-container {
            width: 70px;
            height: 70px;
            flex-shrink: 0; 
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
            background-color: #fff;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-item-img-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
        }

        #pagar {
            background-color: var(--color-barra) !important; 
            color: var(--color-texto-barra) !important;
            font-weight: 700;
            border-radius: 10px !important;
            box-shadow: 0 4px 8px rgba(1, 68, 33, 0.4); 
            border: none !important;
            padding: 10px;
        }
        
        #limpiar-carrito, .offcanvas-body .btn-outline-secondary {
            background-color: var(--color-acento-claro) !important; 
            border-color: var(--color-acento-claro) !important;
            color: var(--color-texto-oscuro) !important; 
            border-radius: 10px !important;
            border: none !important;
            padding: 10px;
        }

        /* TARJETAS DE PRODUCTO */
        .card {
            border-radius: 16px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08); 
            border: 1px solid transparent; 
            transition: transform 0.3s ease; 
        }
        .card:hover {
            transform: translateY(-5px); 
            border-color: var(--color-barra) !important; 
        }
        
        .img-wrapper {
            overflow: hidden;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }
        .product-img {
            height: 280px; 
            width: 100%;
            object-fit: contain;
            background-color: white; 
            padding: 10px; 
            transition: transform 0.5s ease;
        }
        .card:hover .product-img { transform: scale(1.1); }
        
        .card-body .card-title { font-size: 1.3rem; margin-bottom: 0.25rem; }
        .card-body .card-text strong { font-size: 1.4rem; }
        .main-title {
            font-size: 2.2rem;
            font-weight: 700;
            border-bottom: 2px solid var(--color-acento-claro);
            padding-bottom: 1rem;
            margin-bottom: 2.5rem !important;
            text-align: center; 
        }
        
        .badge-marca-client { background-color: #333; color: white; }
        .badge-genero-client { background-color: #C0C0C0; color: #333; }
        .badge-talla-client { border: 1px solid #014421; color: #014421; background: transparent; }
        
        /* === ESTILO PARA EL BADGE DE 2DA OPORTUNIDAD === */
        .badge-segunda { background-color: #014421; color: #ffffff; font-weight: 700; border: none; }

        /* ANIMACI√ìN PARA ALERTAS */
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }

        /* RESPONSIVE */
        @media (max-width: 991.98px) {
            .content-padding { padding-top: 120px; }
            .navbar-custom .navbar-brand { font-size: 2rem; }
            .navbar-logo { height: 60px; width: 60px; }
            .btn-nav-elegant { padding: 0.6rem 1.5rem; font-size: 0.95rem; margin-left: 5px; min-width: 140px; }
            .product-img { height: 180px; }
        }

        @media (max-width: 575.98px) {
            .navbar-custom .navbar-brand { font-size: 1.3rem; } 
            .navbar-logo { height: 45px; width: 45px; }
            .btn-nav-elegant { padding: 0.3rem 0.8rem; font-size: 0.8rem; min-width: 90px; gap: 5px; }
            .content-padding { padding-top: 85px; }
            #productos.row { --bs-gutter-x: 0.75rem; --bs-gutter-y: 0.75rem; }
            #productos.row > .col { flex: 0 0 auto; width: 50%; }
            .product-img { height: 150px; }
            .card .btn-custom { font-size: 0.8rem; padding: 0.3rem 0.75rem; }
        }
    </style>
</head>
<body>
    <div id="alert-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 2000; width: 90%; max-width: 400px;"></div>

    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="lojo.png" alt="Logo" class="navbar-logo">
                <span>FitSyle</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="d-flex flex-column flex-lg-row gap-3 mt-3 mt-lg-0 align-items-start align-items-lg-center justify-content-end w-100">
                    <a href="admin.html" class="btn btn-nav-elegant">
                        <i class="bi bi-person-fill-gear"></i> Admin
                    </a>
                    <button class="btn btn-nav-elegant position-relative" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
                        <i class="bi bi-cart3"></i> Carrito
                        <span id="cart-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none cart-badge" style="padding: 0.5em 0.7em; font-size: 0.7em; top: 5px !important;">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="content-padding">
        <main class="container mt-5" id="productos-section">
            <h2 class="main-title">PRODUCTOS</h2>
            <div id="productos" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
                </div>
        </main>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title" id="cartOffcanvasLabel" style="font-weight: 600; color: var(--color-barra);">üõçÔ∏è Carrito de Compras</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
        </div>
        
        <div class="offcanvas-body d-flex flex-column" style="padding: 1rem;">
            <div id="carrito-contenido" class="flex-grow-1 overflow-auto pe-2">
                <div id="lista-carrito-container">
                    </div>
            </div>

            <div class="mt-auto border-top pt-3 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <strong class="h5 mb-0">Total:</strong> 
                    <span class="text-success h4 fw-bold mb-0">$<span id="total">0.00</span></span>
                </div>
                
                <div class="d-grid gap-2">
                    <button id="pagar" class="btn btn-success" disabled>
                        <i class="bi bi-credit-card"></i> Pagar Ahora
                    </button>
                    <button id="limpiar-carrito" class="btn btn-outline-danger" disabled>
                        <i class="bi bi-trash"></i> Vaciar Carrito
                    </button>
                    <a href="#" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">
                        <i class="bi bi-arrow-left"></i> Seguir Comprando
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyB_LcA4zZk6gZcAPH38HDMxXVqlelgGLQ8",
            authDomain: "proyecto1-b6570.firebaseapp.com",
            projectId: "proyecto1-b6570",
            storageBucket: "proyecto1-b6570.firebasestorage.app",
            messagingSenderId: "575435247117",
            appId: "1:575435247117:web:88bfac2a385f43158a4f44",
            measurementId: "G-R4L645TLDL"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        enableIndexedDbPersistence(db).catch((err) => console.log("Persistencia no disponible:", err));

        const productosDiv = document.getElementById("productos");
        const listaCarritoContainer = document.getElementById("lista-carrito-container"); 
        const totalSpan = document.getElementById("total");
        const pagarBtn = document.getElementById("pagar");
        const cartBadge = document.getElementById("cart-badge");
        const limpiarBtn = document.getElementById("limpiar-carrito");
        let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        let productosData = [];

        function showAlert(message, type = 'success') {
            const alertPlaceholder = document.getElementById('alert-container');
            const wrapper = document.createElement('div');
            
            const icon = type === 'success' ? 'bi-check-circle-fill' : (type === 'danger' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill');
            const color = type === 'success' ? 'success' : (type === 'danger' ? 'danger' : 'primary');
            const title = type === 'success' ? '¬°Excelente!' : 'Atenci√≥n';

            wrapper.innerHTML = [
                `<div class="alert alert-${color} alert-dismissible fade show shadow-lg border-0 d-flex align-items-center" role="alert" style="animation: slideDown 0.5s ease-out;">`,
                `   <i class="bi ${icon} fs-3 me-3"></i>`,
                `   <div>`,
                `      <strong class="d-block">${title}</strong>`,
                `      <span>${message}</span>`,
                `   </div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');

            alertPlaceholder.append(wrapper);

            setTimeout(() => {
                const alertElement = wrapper.firstElementChild;
                if (alertElement) {
                    const alert = new bootstrap.Alert(alertElement);
                    alert.close();
                }
            }, 4000);
        }

        window.addEventListener('online', cargarProductos);
        cargarProductos();

        function cargarProductos() {
            if (!navigator.onLine) {
                const cache = localStorage.getItem('productosCache');
                if (cache) {
                    productosData = JSON.parse(cache);
                    renderProductos(productosData);
                }
                return;
            }

            const productosRef = collection(db, 'productos');
            const q = query(productosRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                productosData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        nombre: data.nombre || 'Sin nombre',
                        precio: Number(data.precio) || 0,
                        descripcion: data.descripcion || 'Sin descripci√≥n',
                        imagenes: data.imagenes || [],
                        imagenUrl: data.imagenUrl || data.imagenes?.[0] || 'https://via.placeholder.com/300x200?text=Imagen+No+Disponible',
                        stock: Number(data.stock) || 0,
                        categoria: data.categoria || 'Sin categor√≠a',
                        marca: data.marca || '',
                        genero: data.genero || '',
                        tallaRopa: data.tallaRopa || null,
                        tallaCalzado: data.tallaCalzado || null,
                        esSegundaOportunidad: data.esSegundaOportunidad || false // DATO AGREGADO
                    };
                });
                localStorage.setItem('productosCache', JSON.stringify(productosData));
                renderProductos(productosData);
            });
        }

        function renderProductos(productos) {
            productosDiv.innerHTML = '';
            if (productos.length === 0) {
                productosDiv.innerHTML = `<div class="col-12 text-center py-5"><p>No hay productos disponibles.</p></div>`;
                return;
            }
            
            productos.forEach(producto => {
                const div = document.createElement("div");
                div.classList.add("col"); 
                
                const imagenesHTML = producto.imagenes && producto.imagenes.length > 1 
                    ? `<div class="thumb-grid">${producto.imagenes.slice(0, 4).map(url => `<img src="${url}" class="thumb">`).join('')}</div>` : '';
                
                let tallaBadge = '';
                if (producto.tallaRopa) tallaBadge = `<span class="badge badge-talla-client ms-1">${producto.tallaRopa}</span>`;
                if (producto.tallaCalzado) tallaBadge = `<span class="badge badge-talla-client ms-1">${producto.tallaCalzado} MX</span>`;

                // LOGICA PARA MOSTRAR BADGE DE 2DA OPORTUNIDAD
                let segundaBadge = '';
                if (producto.esSegundaOportunidad) {
                    segundaBadge = `<span class="badge badge-segunda ms-1">2da oportunidad</span>`;
                }

                div.innerHTML = `
                    <div class="card h-100 shadow-sm d-flex flex-column">
                        <div class="img-wrapper">
                            <img src="${producto.imagenUrl}" class="product-img card-img-top" alt="${producto.nombre}" onerror="this.src='https://via.placeholder.com/300x200?text=Imagen+No+Disponible'">
                        </div>
                        ${imagenesHTML}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${producto.nombre}</h5>
                            <div class="mb-2">
                                <span class="badge badge-marca-client">${producto.marca || 'Generico'}</span>
                                <span class="badge badge-genero-client">${producto.genero || 'Unisex'}</span>
                                ${tallaBadge}
                                ${segundaBadge} </div>
                            <p class="card-text flex-grow-1">${producto.descripcion}</p>
                            <p class="card-text"><strong class="text-success h4">$${producto.precio.toFixed(2)}</strong></p>
                            <p class="card-text"><small class="text-muted"><i class="bi bi-box"></i> ${producto.stock} disponibles</small></p>
                            <div class="mt-auto">
                                <input type="number" min="1" max="${producto.stock}" value="1" id="cantidad-${producto.id}" class="form-control mb-2" placeholder="Cantidad">
                                <button class="btn btn-custom w-100" onclick="agregarAlCarrito('${producto.id}')" ${producto.stock <= 0 ? 'disabled' : ''}>
                                    <i class="bi bi-cart-plus"></i> ${producto.stock <= 0 ? 'Sin Stock' : 'A√±adir al Carrito'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                productosDiv.appendChild(div);
            });
        }

        function calcularDescuento(precio, cantidad) {
            if (cantidad >= 10) return precio * 0.9;
            if (cantidad >= 5) return precio * 0.95;
            return precio;
        }

        window.agregarAlCarrito = function(id) {
            const producto = productosData.find(p => p.id === id);
            if (!producto) return;
            
            const cantidadInput = document.getElementById(`cantidad-${id}`);
            const cantidadSolicitada = parseInt(cantidadInput?.value) || 1;
            
            if (cantidadSolicitada <= 0) {
                showAlert("La cantidad debe ser mayor a 0", "danger");
                return;
            }

            let itemExistente = carrito.find(p => p.id === id);
            let cantidadEnCarrito = itemExistente ? itemExistente.cantidad : 0;
            
            if ((cantidadEnCarrito + cantidadSolicitada) > producto.stock) {
                let disponible = producto.stock - cantidadEnCarrito;
                if (disponible < 0) disponible = 0;
                showAlert(`Stock insuficiente. Solo puedes agregar ${disponible} m√°s.`, "danger");
                return; 
            }

            if (itemExistente) {
                itemExistente.cantidad += cantidadSolicitada;
            } else {
                carrito.push({ 
                    id: producto.id, 
                    nombre: producto.nombre, 
                    precio: producto.precio, 
                    imagenUrl: producto.imagenUrl, 
                    cantidad: cantidadSolicitada 
                });
            }

            localStorage.setItem("carrito", JSON.stringify(carrito));
            mostrarCarrito();
            updateCartBadge();
            
            if (cantidadInput) cantidadInput.value = 1;
        }

        function mostrarCarrito() {
            listaCarritoContainer.innerHTML = "";
            let total = 0;
            
            if (carrito.length === 0) {
                listaCarritoContainer.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-cart-x display-1 d-block mb-3" style="color: #ddd;"></i>
                        <p class="h5">Tu carrito est√° vac√≠o</p>
                    </div>`;
                totalSpan.textContent = "0.00";
                pagarBtn.disabled = true;
                limpiarBtn.disabled = true;
                return;
            }
            pagarBtn.disabled = false;
            limpiarBtn.disabled = false;

            carrito.forEach((item, index) => {
                const productoOriginal = productosData.find(p => p.id === item.id);
                const precioBase = productoOriginal ? productoOriginal.precio : item.precio; 
                const precioConDescuento = calcularDescuento(precioBase, item.cantidad);
                const subtotal = precioConDescuento * item.cantidad;
                total += subtotal;
                
                const itemDiv = document.createElement("div");
                itemDiv.classList.add("cart-item-box");
                
                itemDiv.innerHTML = `
                    <div class="d-flex align-items-center flex-grow-1 overflow-hidden">
                        <div class="cart-item-img-container">
                             <img src="${item.imagenUrl}" alt="${item.nombre}" onerror="this.src='https://via.placeholder.com/70x70?text=Img'">
                        </div>
                        <div class="flex-grow-1 pe-2">
                            <strong class="d-block text-truncate" style="color: var(--color-texto-oscuro); max-width: 150px;">${item.nombre}</strong>
                            <div class="d-flex align-items-center flex-wrap">
                                <span class="badge bg-light text-dark border me-2">${item.cantidad} x $${precioBase.toFixed(0)}</span>
                                <span class="text-success fw-bold">$${subtotal.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-danger btn-sm rounded-circle ms-2" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;" onclick="eliminarDelCarrito(${index})">
                        <i class="bi bi-x-lg" style="font-size: 0.8rem;"></i>
                    </button>
                `;
                listaCarritoContainer.appendChild(itemDiv);
            });
            totalSpan.textContent = total.toFixed(2);
        }

        window.eliminarDelCarrito = function(index) {
            if (confirm("¬øEliminar producto?")) {
                carrito.splice(index, 1);
                localStorage.setItem("carrito", JSON.stringify(carrito));
                mostrarCarrito();
                updateCartBadge();
            }
        }

        function updateCartBadge() {
            const totalItems = carrito.reduce((sum, item) => sum + item.cantidad, 0);
            cartBadge.textContent = totalItems;
            cartBadge.classList.toggle('d-none', totalItems === 0);
        }

        limpiarBtn.addEventListener("click", () => {
            if (confirm('¬øVaciar carrito?')) {
                carrito = [];
                localStorage.removeItem("carrito");
                mostrarCarrito();
                updateCartBadge();
            }
        });

        pagarBtn.addEventListener("click", () => {
            const totalAmount = document.getElementById('total').textContent;
            
            if (confirm(`¬øConfirmar compra por $${totalAmount}?`)) {
                carrito = [];
                localStorage.removeItem("carrito");
                mostrarCarrito();
                updateCartBadge();
                const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('cartOffcanvas'));
                if (offcanvas) offcanvas.hide();
                showAlert("¬°Compra realizada con √©xito! Gracias por tu preferencia.", "success");
            }
        });

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

        mostrarCarrito();
        updateCartBadge();
    </script>
</body>
</html>